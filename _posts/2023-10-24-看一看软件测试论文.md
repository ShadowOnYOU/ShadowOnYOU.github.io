# Guided, Stochastic Model-Based GUI Testing of Android Apps

## 1. 摘要

移动应用程序大多在复杂的环境中过，并且是在一个追求上市的压力之下进行的开发。

如何保证其正确性和可靠性？

本文介绍——Stoat方法。用于在安卓应用上执行基于随机模型的测试

两个阶段：1. 给定一个应用程序作为输入，使用动态分析结合加权UI探索策略和静态分析来反向工程应用程序的GUI交互的随机模型。2. 采用Gibbs采样算法，迭代的编译/精炼随机模型，并从变异的模型中u引导测试用例，以实现高代码和模型覆盖率，并展示多样的测试序列。

结果：（1）Stoat生成的模型覆盖的代码比现有建模工具的模型多出17％至31％；（2）Stoat检测到的唯一崩溃数量比两个最先进的测试工具Monkey和Sapienz多3倍。此外，Stoat还测试了1661个最受欢迎的Google Play应用程序，并发现了2110个以前未知和独特的崩溃。

## 2. 介绍

存在前面所说的问题，所以如何进行充分的测试成为每一款应用上线前需要重视的事情

许多技术方法：

1. 符号执行：在源代码级别跟踪时间的起源和处理方式，并通过详尽的探索路径生成测试。
2. 随机测试：通过生成一系列随机事件对应用程序进行模糊测试。
3. 进化算法：通过随机变异和交叉事件序列来生成测试
4. 模型驱动测试MBT：通过模型抽象应用程序行为，然后从模型中推导测试用例来验证应用程序。
   1. 问题在于：从模型中详尽生成测试用例以验证应用程序行为是很困难的
   2. 这样的测试缺乏强有力的引导，往往是冗余且无效的，难以检测到错误
5. 之前的一些机遇模型的GUI测试的研究：只考虑UI级别的事件（点击，编辑），而在测试中忽略系统级别的事件（屏幕旋转，来电）。
   1. 如果不结合这两种事件，MBT的有效性也会受到限制

大多数应用程序在实际开发的过程中并没有使用模型

前面凸显了开发有效的机遇模型的测试技术以释放其潜力的重要性

Stoat （STOchastic model App Tester）

旨在从GUI模型中彻底测试应用程序的功能，并通过强制执行各种用户/系统交互来验证应用程序的行为。

### 工作原理：

给定一个应用程序作为输入，Stoat分为两个阶段。

首先，它从应用程序生成一个随机模型来描述其GUI交互。在我们的设置中，应用程序的随机模型是一个有限状态机（FSM），其边缘与测试生成的概率相关联。具体而言，Stoat采用动态分析技术，结合加权UI探索策略和静态分析，来探索应用程序的行为并构建随机模型。

其次，Stoat迭代地变异随机模型，并从模型变异体中生成测试用例。通过扰动概率，Stoat能够生成具有各种事件组合的测试用例，以充分测试GUI交互，并有针对性地引导测试走向少访问的路径以检测深层次的错误。

采用了受尔可夫链蒙特卡洛（MCMC）采样启发的引导搜索算法，用于寻找“好”的模型，期望生成的测试用例具有多样性，并实现高代码和模型覆盖率。

增强MBT：在MCMC采样期间随机注入各种系统级别事件到UI测试中。避免了将系统事件纳入行为模型的复杂性，并进一步引入外部环境的影响以检测复杂的错误。

Gibbs采样方法在第二个阶段起到了重要的作用。Stoat利用Gibbs采样方法迭代的变异和改进应用程序的随机模型，以引导测试生成。

【Gibbs的作用】：Stoat利用Gibbs采样从当前的随机模型中选择一个状态，并对其进行变异或改进。这个过程基于当前状态的概率分布，并使用一些策略来引导变异和改进的方向。通过迭代地应用Gibbs采样，Stoat可以逐步改进随机模型，使其更好地覆盖代码和模型，并生成具有多样性序列的测试用例。

![截屏2023-10-24 19.06.57](https://github.com/ShadowOnYOU/images/blob/main/test202310241907406.png?raw=true)

### 实现：

模型构建。Stoat采用了一种动态分析技术，结合加权UI探索策略和静态分析，以有效地探索应用程序的行为并构建模型。这种增强策略帮助生成更完整的模型，其代码覆盖范围可以比现有GUI探索工具生成的模型多覆盖17％至31％的代码。

故障检测。我们采用Gibbs采样作为MCMC采样的一种实例，来指导基于随机模型的测试。在对93个开源应用进行测试时，Stoat实现了令人满意的覆盖率，并检测到的唯一崩溃数比最先进的测试工具Monkey和Sapienz多出大约3倍，这清楚地证明了我们方法的优势。特别是，在基于模型的测试过程中，Stoat通过注入系统级事件检测到了额外的91个崩溃。

实施和评估。我们已经将Stoat实现为一个自动化工具，并在谷歌应用商店的1661个最受欢迎的应用程序上进行了评估。Stoat从691个应用程序中检测到了2110个唯一的崩溃。目前已确认其中20个崩溃是真实的错误，并已修复其中8个。这些结果表明Stoat在测试现实世界的应用程序方面是有效的。

## 3. 过程概览

### 第一阶段

1. 构建一个随机优先状态机来描述应用程序的行为
2. 使用一种动态分析技术，结合加权UI探索策略，高效探索应用程序的行为
3. 通过分析应用程序页面的UI层次结构来推断输入事件，并动态优先执行这些事件以最大化代码覆盖率。
4. 此外，为了识别一些潜在缺失的事件，还会执行静态分析，扫描应用程序代码中注册的事件监听器。
5. 模型会记录所有UI事件的执行频率，并在后续使用它们来生成模型中转换的初始概率值

### 第二阶段

1. 用第一阶段的模型迭代的引导测试生成，以实现高覆盖率和多样化的事件序列
2. 采用的是循环工作的方式
3. 随机变异当前随机模型的转换概率（步骤4），根据概率从模型中生成测试用例（步骤5），随机将系统级事件（在步骤3中通过静态分析分析）注入这些UI级别的测试用例以增强MBT（步骤6），在应用程序上回放这些测试用例（步骤7）并收集测试结果，如代码和模型覆盖率以及事件序列的多样性（步骤8）

利用Gibbs采样来决定是否接受或拒绝新提出的模型（步骤9），具有更好目标值的模型将被接受用于下一次变异和采样迭代；否则，它将以一定概率被拒绝，以避免陷入局部最优解（如果被拒绝，则重新使用原始模型）。一旦检测到任何错误（例如崩溃或无响应），将进行进一步的分析以诊断与相应测试相关的错误（步骤10）。

### 示例：

Bites构建的应用模型的一部分

![截屏2023-10-24 21.14.00](https://github.com/ShadowOnYOU/images/blob/main/test202310242114535.png?raw=true)

每个节点表示一个应用程序状态，每个变表示状态转换。

例如，当事件e6发生时（即在Recipes页面上点击食谱项），可以从Recipes导航到Ingredients，概率为p6。

## 3. 不知道起什么标题

### 3.1 Stochastic Model

Stoat使用随机有限状态机模型表示应用程序的行为。

随机FSM被定义为一个五元组M = (Q, Σ, δ, s0, F)，其中Q和Σ分别是应用程序状态和输入事件的集合，s0 ∈ Q是起始应用程序状态，F ⊆ Q是最终状态的集合，δ：Q × Σ → P(Q × [0, 1])是概率转换函数。P（·）是幂集运算符，每个转换的形式为（s，e，（s'，p）），表示事件e触发从状态s到状态s'的转换的概率为p。

应用程序状态s被抽象为应用程序的页面：表现小部件层次结构树，其中非叶节点表示布局小部件（如LinearLayout）叶节点表示可执行的小部件（例如button）。

当页面的结构和属性发生变化时，创造一个新的状态。若程序退出/崩溃，将结束状态视为最终状态。

边对应于表示UI操作的输入事件e。

应用程序通过处理输入事件e从一个状态s移动到另一个状态s‘。

为每一个转换e分配一个概率值p，白哦是在测试生成中选择e的权重。（这个p一般是通过最初e在s中观察到的执行次数与所有事件的执行次数的比值）

如何生成测试用例：根据概率策略从随机模型生成事件序列。从s0开始，根据概率值从相应的应用状态中选择一个事件，直到达到最大序列长度或达到结束状态为止。

### 3.2 模型构建

Stoat采用动态UI探索策略，并结合静态分析。

作者从50个GooglePlay应用中总结了三个关键观察结果。

1. 事件执行频率。所有的UI事件都有机会被执行。执行概率较低的事件在后续的探索过程中更有可能被选择

2. 事件类型。不同类型的事件并不是等概率选择的。例如，与普通UI事件（点击）相比，导航事件被赋予不同的优先级，以确保它们在正确的时机被触发。

3. 未访问的子小部件数量。若一个事件在下一个页面上引发了更多的新的UI小部件，那么它将被有限考虑，因为在具有新功能的页面上应该花费更多的努力。

   ![截屏2023-10-24 21.42.25](https://github.com/ShadowOnYOU/images/blob/main/test202310242142989.png?raw=true)

   #### 解释一下这个算法：

   算法将一个应用作为输入，并输出相应的模型M。

   6-7:算法根据当前应用页面s上的UI小部件推断可调用的事件E，并将它们添加到存储动态分析期间所有事件的事件列表中

   8-9:在每次执行之前，将根据公式(1)更新列表中所有事件的权重

   10-11:选择当前页面上具有最大权重的事件进行执行

   12-14:若进入了未知状态，将重新启动应用程序或将其导航回到前一页。

   ​	会额外将这个事件添加到Tabu列表，并在10行进行排除

   15:接受返回的状态和执行的事件来构建模型

   17，18-24:根据观察到的执行次数，为M中的所有转换分配初始概率值。

#### 静态事件识别

4:使用静态分析来识别动态分析中可能错过的这些潜在事件

#### 模型压缩

这个模型将结构上不同的页面标识为不同的状态，并合并相似的状态来压缩模型

## 4. Gibbs 采样

### 4.1 Gibbs采样

是Metropolis-Hastings算法的特例。通过迭代的从与概率密度成比例的函数中生成样本。其中当前样本的选择仅依赖于前一个样本。经过多次迭代，这些样本可以更好的近似所需的分布。

【这边有一个公式，偷懒了，没看】

### 4.2 目标函数

三个指标：

1. 代码覆盖率
2. 模型覆盖率
3. 测试多样性

### 4.3 Gibbs采样引导编译模型

迭代的机遇Gibbs采样算法确定的条件概率分布来对给定模型进行变异

![截屏2023-10-25 10.18.19](https://github.com/ShadowOnYOU/images/blob/main/test202310251018776.png?raw=true)

假设应用程序具有n个应用程序状态，s1，...，si，...，sn，并且每个状态si（1≤i≤n）具有k个事件转换，e1，...，ej，...，ek。Stoat随机决定是否变异每个应用程序状态si的转换概率（第3-9行）。如果选择状态si，则Stoat将随机将转换ej的原始概率值pj变异为新的概率值pj'，其中pj' = pj + mSize或pj - mSize。直观上，新生成的概率值pj'在pj附近（可以高于或低于pj），以便与M相比，新模型M'可以生成非常不同的事件序列。为了加快收敛速度，mSize在实现中被设置为一个固定值（例如0.1)。对于其他转换概率，应用类似的过程，但约束条件p1' +...+ pj' +...+ pk' = 1仍然成立。对于未选择的状态，它们的转换概率保持不变，因此新模型M'在这些变异的概率值的条件下，有条件地依赖于先前的模型M。

为了模拟环境的交互，Stoat将系统级事件随机注入到从变异模型M'生成的测试套件T'中（第11-15行）。然后，将T'在应用程序上回放以验证其行为。T'的测试结果用于确定M'的接受比率。如果T'能够改进目标值，则M'将在下一次迭代中进行变异（第19-20行）。否则，原始模型M进行变异。算法持续进行，直到耗尽测试预算。如果应用程序崩溃或无响应，则记录一个可疑的错误（第17-18行），并转储相应的错误堆栈以进行错误诊断。

### 4.4 系统级事件

简单但有效的策略：随机将系统级事件注入到UI级事件序列中。

支持三种系统级事件的来源：

1. 5中用户操作（屏幕旋转、音量控制、电话、短信、应用切换）
2. 113个系统级广播意图，用于模拟系统消息
3. 应用程序特别关注的事件

## 5. 评估

这部分主要讲的是作者运用这个模型进行测试的过程。得出的结论在第一部分得以显现

此模型存在的缺陷：

1. 在测试过程中，Stoat发出一个事件，等待其生效，然后再发出下一个事件。这种同步确保了测试的完整性，但可能会错过那些只能通过快速操作才能显现的错误。
2. Stoat可能会从模型中生成“不可行”的事件序列。为了缓解这个问题，Stoat通过对象索引而不是一些易变属性（例如文本）来定位UI小部件，并在无法定位目标UI时跳过事件。
3. Stoat生成的模型仍然不完整，因为它无法捕捉到UI探索过程中的所有可能行为，而这仍然是GUI测试中一个重要的研究目标。例如，Stoat对于具有不规则手势（例如PinchZoom、绘图）和特定输入数据格式的应用程序无效。未来的工作可以结合符号执行、字符串分析或学习算法来解决这些问题。

## 6. 相关联工作

模型驱动的测试（MBT）是一种常用的测试方法，它的关键任务是从系统中提取一个适当的抽象行为模型。在GUI测试中，手动构建模型是耗时且容易出错的，因此研究人员开发了一些工具来自动化这一过程。其中一些工具使用事件流图或状态机来表示应用程序模型，并通过图遍历算法生成测试用例。其他方法则采用符号执行、随机测试、组合测试等技术来进行测试。MBT的目标是生成高覆盖度的测试用例，以发现应用程序中的错误。

基于MCMC采样的测试是一种利用马尔可夫链蒙特卡罗（MCMC）采样技术解决软件测试问题的方法。这种方法使用先验知识和先前的测试结果来估计参数，并优化测试用例的生成和选择。例如，可以使用MCMC采样来生成多样性的测试用例，以实现高代码覆盖率。MCMC采样还可以用于优化测试证书、指导模糊测试等方面。

## 7. 总结

Stoat是一种创新的自动化模型驱动测试方法，用于改进GUI测试。它利用应用程序的行为模型，通过迭代的方式优化测试生成，以实现高覆盖率和多样性的事件序列。我们在大量应用程序上进行了评估，结果显示Stoat比现有技术更有效。我们相信Stoat的高级方法是通用的，并可以在其他测试领域中得到有效应用。
